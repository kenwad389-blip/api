<!doctype html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>スケジュール管理</title>
    <!-- jQuery読み込み -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <!-- axios読み込み -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- apiキー読み込み -->
    <script type="text/javascript" src="js/config.js"></script>

    <!-- CSS読み込み -->
    <link rel="stylesheet" href="css/style.css" />
    <link rel="icon" href="/favicon.ico" type="image/x-icon">

    <style></style>
</head>
<body>
<header>
    <h1>AIスケジューラー</h1>
</header>
<main>
    <!-- 入力エリア -->
    <div class="input-group">
        <textarea id="userInput" placeholder="例: 次の金曜の15時に会議室Aで定例ミーティング"></textarea>
        <button id="addBtn">予定を追加</button>
        <p id="loadingMsg" class="loading">AIが解析中 & 保存中...</p>
    </div>

    <!-- ★追加: 表示期間フィルター -->
    <div class="filter-group">
        <label>表示期間:</label>
        <input type="date" id="filterStartDate">
        <span>～</span>
        <input type="date" id="filterEndDate">
        <button id="resetFilterBtn" style="margin-left:auto; font-size:0.8em;">今週を表示</button>
    </div>

    <h2>予定リスト <span id="scheduleCount" style="font-size:0.7em; font-weight:normal;"></span></h2>
    <div id="scheduleList"></div>

    <!-- 編集用モーダル -->
    <div id="editModal">
        <div class="modal-content">
            <h3>予定の編集</h3>
            <label>タイトル</label> <input type="text" id="editTitle">
            <label>日付</label> <input type="date" id="editDate">
            <label>時間</label> <input type="time" id="editTime">
            <label>詳細</label> <textarea id="editDescription" rows="3"></textarea>
            
            <div class="modal-actions">
                <button id="cancelEditBtn" class="cancel-btn">キャンセル</button>
                <button id="saveEditBtn" class="save-btn">保存する</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, push, onValue, update, remove } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

        // ==========================================
        // 初期化
        // ==========================================
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const genAI = new GoogleGenerativeAI(GEMINI_API_KEY);
        
        // 注意: gemini-2.5-pro が利用できない場合は gemini-1.5-pro 等に変更してください
        const model = genAI.getGenerativeModel({ model: "gemini-2.5-pro" });

        const userInput = document.getElementById('userInput');
        const addBtn = document.getElementById('addBtn');
        const scheduleList = document.getElementById('scheduleList');
        const loadingMsg = document.getElementById('loadingMsg');
        
        // フィルター用要素
        const filterStartDate = document.getElementById('filterStartDate');
        const filterEndDate = document.getElementById('filterEndDate');
        const resetFilterBtn = document.getElementById('resetFilterBtn');
        const scheduleCount = document.getElementById('scheduleCount');

        const editModal = document.getElementById('editModal');
        const editTitle = document.getElementById('editTitle');
        const editDate = document.getElementById('editDate');
        const editTime = document.getElementById('editTime');
        const editDescription = document.getElementById('editDescription');
        const saveEditBtn = document.getElementById('saveEditBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');

        let currentEditId = null;
        let allSchedulesData = []; // 全データを保持する配列

        // ==========================================
        // ★追加: 期間設定用関数
        // ==========================================
        function setNextOneWeekRange() {
            const today = new Date();
            const nextWeek = new Date();
            nextWeek.setDate(today.getDate() + 7); // 7日後

            // YYYY-MM-DD形式に変換
            const formatDate = (date) => date.toISOString().split('T')[0];

            filterStartDate.value = formatDate(today);
            filterEndDate.value = formatDate(nextWeek);
        }

        // 初期表示時に期間をセット
        setNextOneWeekRange();

        // ==========================================
        // AI解析
        // ==========================================
        async function parseTextToSchedule(text) {
            const today = new Date().toISOString().split('T')[0];
            
            const prompt = `
                今日の日付: ${today}
                ユーザーの入力からイベント情報を抽出し、JSON形式で返してください。
                
                出力JSONの仕様:
                {
                    "title": "イベント名 (文字列)",
                    "date": "YYYY-MM-DD (日付文字列)",
                    "time": "HH:mm (時間文字列, なければ空文字)",
                    "description": "詳細 (文字列, なければ空文字)"
                }

                ユーザー入力: "${text}"
            `;

            try {
                const result = await model.generateContent(prompt);
                const response = await result.response;
                let jsonText = response.text();
                jsonText = jsonText.replace(/```json|```/g, "").trim();
                return JSON.parse(jsonText);
            } catch (error) {
                console.error("AI解析エラー:", error);
                alert("AIエラー: " + error.message);
                return null;
            }
        }

        // ==========================================
        // イベント処理: 追加
        // ==========================================
        addBtn.addEventListener('click', async () => {
            const text = userInput.value;
            if (!text) return;

            loadingMsg.style.display = 'block';
            addBtn.disabled = true;

            const scheduleData = await parseTextToSchedule(text);

            if (scheduleData) {
                if (!scheduleData.title || !scheduleData.date || !scheduleData.time || !scheduleData.description) {
                    alert("【登録エラー】\n必要な情報が不足しています。\nより具体的に入力してください。");
                    loadingMsg.style.display = 'none';
                    addBtn.disabled = false;
                    return; 
                }

                try {
                    const dbRef = ref(db, 'schedules');
                    await push(dbRef, {
                        ...scheduleData,
                        createdAt: new Date().toISOString()
                    });
                    userInput.value = "";
                } catch (e) {
                    console.error(e);
                    alert("保存エラー: データベース接続を確認してください");
                }
            } else {
                alert("AI解析失敗。再試行してください。");
            }

            loadingMsg.style.display = 'none';
            addBtn.disabled = false;
        });

        // ==========================================
        // ★修正: リスト取得 & フィルタリング表示
        // ==========================================
        const schedulesRef = ref(db, 'schedules');

        // データ変更時に全データを取得し、グローバル変数に保存してから描画を呼ぶ
        onValue(schedulesRef, (snapshot) => {
            const data = snapshot.val();
            if (!data) {
                allSchedulesData = [];
                renderScheduleList();
                return;
            }

            // オブジェクトを配列に変換
            allSchedulesData = Object.entries(data).map(([key, value]) => {
                return { id: key, ...value };
            });

            // 日付順にソート
            allSchedulesData.sort((a, b) => new Date(a.date) - new Date(b.date));

            // 描画実行
            renderScheduleList();
        });

        // 描画関数 (フィルター適用)
        function renderScheduleList() {
            scheduleList.innerHTML = "";
            
            const startStr = filterStartDate.value;
            const endStr = filterEndDate.value;

            // 日付フィルター適用
            const filteredData = allSchedulesData.filter(item => {
                if (!startStr || !endStr) return true; // 期間未設定なら全表示
                return item.date >= startStr && item.date <= endStr;
            });

            scheduleCount.innerText = `(${filteredData.length}件)`;

            if (filteredData.length === 0) {
                scheduleList.innerHTML = "<p>指定期間の予定はありません。</p>";
                return;
            }

            filteredData.forEach((item) => {
                const card = document.createElement('div');
                card.className = 'event-card';
                card.innerHTML = `
                    <div class="date">${item.date} ${item.time}</div>
                    <h3>${item.title}</h3>
                    <p>${item.description}</p>
                    <div class="card-actions"></div>
                `;

                const actionContainer = card.querySelector('.card-actions');

                const editButton = document.createElement('button');
                editButton.className = 'edit-btn';
                editButton.innerText = '編集';
                editButton.onclick = () => openEditModal(item);
                
                const deleteButton = document.createElement('button');
                deleteButton.className = 'delete-btn';
                deleteButton.innerText = '削除';
                deleteButton.onclick = async () => {
                    if (confirm(`「${item.title}」を削除しますか？`)) {
                        try {
                            const itemRef = ref(db, 'schedules/' + item.id);
                            await remove(itemRef);
                        } catch (e) {
                            alert("削除失敗");
                        }
                    }
                };

                actionContainer.appendChild(editButton);
                actionContainer.appendChild(deleteButton);
                scheduleList.appendChild(card);
            });
        }

        // ==========================================
        // ★追加: フィルター操作イベント
        // ==========================================
        // 日付が変わったら即座にリストを再描画
        filterStartDate.addEventListener('change', renderScheduleList);
        filterEndDate.addEventListener('change', renderScheduleList);

        // 「今週を表示」ボタン
        resetFilterBtn.addEventListener('click', () => {
            setNextOneWeekRange();
            renderScheduleList();
        });

        // ==========================================
        // 編集機能 (変更なし)
        // ==========================================
        function openEditModal(item) {
            currentEditId = item.id;
            editTitle.value = item.title || "";
            editDate.value = item.date || "";
            editTime.value = item.time || "";
            editDescription.value = item.description || "";
            editModal.style.display = 'flex';
        }

        cancelEditBtn.addEventListener('click', () => {
            editModal.style.display = 'none';
            currentEditId = null;
        });

        saveEditBtn.addEventListener('click', async () => {
            if (!currentEditId) return;
            const itemRef = ref(db, 'schedules/' + currentEditId);
            try {
                await update(itemRef, {
                    title: editTitle.value,
                    date: editDate.value,
                    time: editTime.value,
                    description: editDescription.value
                });
                editModal.style.display = 'none';
                currentEditId = null;
            } catch (e) {
                alert("更新失敗");
            }
        });

    </script>
</main>
</body>
</html>